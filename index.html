<script>
/* ===== URL ===== */
const WORKER_URL = "https://still-hat-5795.salvatifranc.workers.dev/";
const MANUAL_URL = "https://raw.githubusercontent.com/salvatifranc-lang/survival-game/main/HOPE_TOWN_GAME_MANUAL.txt";

/* ===== STATE ===== */
let playerState = { salute: 10, stamina: 10, livello: 1 };
let lastTest = null;
let gameManual = "";

/* ===== DIARIES ===== */
let campaignDiary = {
  synopsis: "",
  livello: 1,
  inventario: [],
  abilit√†: []
};

let missionDiary = [];

/* ===== LOAD MANUAL ===== */
async function loadGameManual() {
  try {
    const res = await fetch(MANUAL_URL);
    gameManual = await res.text();
    console.log("Manuale di gioco caricato");
  } catch (err) {
    console.error("Errore caricamento manuale", err);
    gameManual = "";
  }
}

/* ===== TYPEWRITER ===== */
function typeWriter(el, text, speed = 18) {
  if (!el) return;

  el.innerText = "";
  let i = 0;
  const cursor = document.createElement("span");
  cursor.className = "cursor";
  cursor.innerText = "‚ñà";
  el.appendChild(cursor);

  const interval = setInterval(() => {
    if (i < text.length) {
      cursor.before(text.charAt(i));
      i++;
    } else {
      clearInterval(interval);
      cursor.remove();
    }
  }, speed);
}

/* ===== STATS UI ===== */
function updateStatsUI() {
  const s = document.getElementById("stat-salute");
  const st = document.getElementById("stat-stamina");
  const l = document.getElementById("stat-livello");

  if (s) s.innerText = playerState.salute;
  if (st) st.innerText = playerState.stamina;
  if (l) l.innerText = playerState.livello;
}

/* ===== DADO ===== */
function rollD6() {
  return Math.floor(Math.random() * 6) + 1;
}

function resolveTest(d6, difficulty) {
  const table = {
    "Estremo":        ["critical_fail","critical_fail","fail","fail","partial","bonus"],
    "Molto Rischioso":["critical_fail","fail","fail","partial","success","bonus"],
    "Rischioso":     ["critical_fail","fail","partial","partial","success","bonus"],
    "Standard":      ["critical_fail","fail","partial","partial","success","bonus"],
    "Facile":        ["fail","partial","success","success","bonus","bonus"],
    "Molto Facile":  ["partial","partial","success","success","bonus","bonus"]
  };
  return table[difficulty]?.[d6 - 1] || "fail";
}

function esitoLabel(code) {
  const map = {
    critical_fail: "Fallimento Critico",
    fail: "Fallimento",
    partial: "Successo Parziale",
    success: "Successo",
    bonus: "Successo con Bonus"
  };
  return map[code] || code;
}

/* ===== LOOP ===== */
async function playTurn(action) {

  const testToSend = lastTest;
  lastTest = null;

  /* testo reale della scelta (SAFE) */
  let choiceText = "";
  const choiceEl = document.getElementById("choice" + action);
  if (choiceEl) choiceText = choiceEl.innerText;

  /* ultima narrazione */
  const narrationEl = document.getElementById("narration");
  const previousNarration = narrationEl ? narrationEl.innerText : "";

  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        last_action: action,
        choice_text: choiceText,
        last_narration: previousNarration,
        test_result: testToSend,

        player_state: playerState,

        game_manual: gameManual,
        campaign_diary: campaignDiary,
        mission_diary: missionDiary
      })
    });

    if (!res.ok) {
      if (narrationEl) narrationEl.innerText = "Errore di comunicazione con il server.";
      return;
    }

    const data = await res.json();

    /* ===== NARRATION ===== */
    typeWriter(narrationEl, data.narration || "‚Ä¶", 20);

    setTimeout(() => {
      typeWriter(document.getElementById("choiceA"), "A) " + data.choices.A, 12);
      typeWriter(document.getElementById("choiceB"), "B) " + data.choices.B, 12);
      typeWriter(document.getElementById("choiceC"), "C) " + data.choices.C, 12);
    }, 300);

    /* ===== TEST ===== */
    if (data.test && data.test.required === true) {

      const difficulty = data.test.difficulty;
      const d6 = rollD6();
      const outcome = resolveTest(d6, difficulty);

      document.getElementById("test-box").innerHTML =
        `üé≤ Dado: ${d6}<br>` +
        `‚ö†Ô∏è Difficolt√†: ${difficulty}<br>` +
        `üß™ Esito: ${esitoLabel(outcome)}`;

      if (data.outcomes && data.outcomes[outcome]?.effects) {
        const eff = data.outcomes[outcome].effects;
        if (eff.salute) playerState.salute += eff.salute;
        if (eff.stamina) playerState.stamina += eff.stamina;
        updateStatsUI();
      }

      lastTest = { d6, outcome };

    } else {
      document.getElementById("test-box").innerHTML =
        `üé≤ Dado: ‚Äî<br>‚ö†Ô∏è Difficolt√†: ‚Äî<br>üß™ Esito: ‚Äî`;
    }

    /* ===== UPDATE MISSION DIARY ===== */
    missionDiary.push({
      narration: data.narration,
      choice: choiceText,
      test: testToSend
    });

  } catch (err) {
    console.error(err);
    if (narrationEl) narrationEl.innerText = "Errore di comunicazione.";
  }
}

function choose(letter) {
  playTurn(letter);
}

/* ===== START ===== */
updateStatsUI();

(async () => {
  await loadGameManual();
  playTurn("inizio");
})();
</script>
