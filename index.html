<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Survival AI</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    button {
      display: block;
      margin: 8px 0;
      width: 100%;
      padding: 10px;
      background: #222;
      color: #eee;
      border: 1px solid #444;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    #dice {
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>Survival</h2>
<div id="hud"></div>
<p id="narration">Caricamentoâ€¦</p>

<div id="choices">
  <button onclick="choose('A')"></button>
  <button onclick="choose('B')"></button>
  <button onclick="choose('C')"></button>
</div>

<div id="dice"></div>

<script>
console.log("JS caricato");

let playerState = {
  salute: 10,
  stress: 0,
  risorse: 5
};

let lastAction = "inizio";

async function playTurn(action) {
  disableChoices();
  document.getElementById("dice").innerText = "";

  try {
    const res = await fetch("/api", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        last_action: action,
        player_state: playerState
      })
    });

    if (!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();

    document.getElementById("narration").innerText = data.narration;

    const buttons = document.querySelectorAll("#choices button");
    buttons[0].innerText = "A) " + data.choices.A;
    buttons[1].innerText = "B) " + data.choices.B;
    buttons[2].innerText = "C) " + data.choices.C;

    if (data.test.required) {
      const roll = rollDice();
      const success = roll >= data.test.difficulty;
      applyEffects(success ? data.effects.success : data.effects.fail);
    }

    updateHUD();
    enableChoices();

  } catch (err) {
    console.error(err);
    document.getElementById("narration").innerText =
      "Errore di comunicazione con il server.";
    enableChoices();
  }
}

function choose(letter) {
  lastAction = letter;
  playTurn(letter);
}

function rollDice() {
  const roll = Math.ceil(Math.random() * 6);
  document.getElementById("dice").innerText = "ðŸŽ² Tiro: " + roll;
  return roll;
}

function applyEffects(effects) {
  ["salute", "stress", "risorse"].forEach(key => {
    if (typeof effects[key] === "number") {
      playerState[key] += effects[key];
    }
  });

  playerState.salute = Math.max(0, playerState.salute);
  playerState.stress = Math.max(0, playerState.stress);
  playerState.risorse = Math.max(0, playerState.risorse);
}

function updateHUD() {
  document.getElementById("hud").innerText =
    `â¤ï¸ ${playerState.salute} | ðŸ§  ${playerState.stress} | ðŸŽ’ ${playerState.risorse}`;
}

function disableChoices() {
  document.querySelectorAll("#choices button").forEach(b => b.disabled = true);
}

function enableChoices() {
  document.querySelectorAll("#choices button").forEach(b => b.disabled = false);
}

console.log("Avvio gioco");
playTurn("inizio");
</script>

</body>
</html>
