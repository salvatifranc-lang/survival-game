<script>
/* ===== URL ===== */
const WORKER_URL = "https://still-hat-5795.salvatifranc.workers.dev/";
const MANUAL_URL = "https://raw.githubusercontent.com/salvatifranc-lang/survival-game/main/HOPE_TOWN_GAME_MANUAL.txt";

/* ===== STATE ===== */
let playerState = { salute: 10, stamina: 10, livello: 1 };
let lastTest = null;
let gameManual = "";

/* ===== DIARIES ===== */
let campaignDiary = {
  synopsis: "",
  livello: 1,
  inventario: [],
  abilit√†: []
};

let missionDiary = [];

/* ===== LOAD MANUAL ===== */
async function loadGameManual() {
  try {
    const res = await fetch(MANUAL_URL);
    gameManual = await res.text();
    console.log("Manuale di gioco caricato");
  } catch (err) {
    console.error("Errore caricamento manuale", err);
    gameManual = "";
  }
}

/* ===== TYPEWRITER ===== */
function typeWriter(el, text, speed = 18) {
  el.innerText = "";
  let i = 0;
  const cursor = document.createElement("span");
  cursor.className = "cursor";
  cursor.innerText = "‚ñà";
  el.appendChild(cursor);

  const interval = setInterval(() => {
    if (i < text.length) {
      cursor.before(text.charAt(i));
      i++;
    } else {
      clearInterval(interval);
      cursor.remove();
    }
  }, speed);
}

/* ===== STATS UI ===== */
function updateStatsUI() {
  document.getElementById("stat-salute").innerText = playerState.salute;
  document.getElementById("stat-stamina").innerText = playerState.stamina;
  document.getElementById("stat-livello").innerText = playerState.livello;
}

/* ===== DADO ===== */
function rollD6() {
  return Math.floor(Math.random() * 6) + 1;
}

function resolveTest(d6, difficulty) {
  const table = {
    "Estremo":        ["critical_fail","critical_fail","fail","fail","partial","bonus"],
    "Molto Rischioso":["critical_fail","fail","fail","partial","success","bonus"],
    "Rischioso":     ["critical_fail","fail","partial","partial","success","bonus"],
    "Standard":      ["critical_fail","fail","partial","partial","success","bonus"],
    "Facile":        ["fail","partial","success","success","bonus","bonus"],
    "Molto Facile":  ["partial","partial","success","success","bonus","bonus"]
  };
  return table[difficulty][d6 - 1];
}

function esitoLabel(code) {
  return {
    critical_fail: "Fallimento Critico",
    fail: "Fallimento",
    partial: "Successo Parziale",
    success: "Successo",
    bonus: "Successo con Bonus"
  }[code];
}

/* ===== LOOP ===== */
async function playTurn(action) {

  const testToSend = lastTest;
  lastTest = null;

  /* testo reale della scelta */
  const choiceText = document.getElementById("choice" + action)?.innerText || "";

  /* ultima narrazione */
  const previousNarration = document.getElementById("narration").innerText || "";

  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        /* CORE */
        last_action: action,
        choice_text: choiceText,
        last_narration: previousNarration,
        test_result: testToSend,

        /* STATE */
        player_state: playerState,

        /* SUPPORT */
        game_manual: gameManual,
        campaign_diary: campaignDiary,
        mission_diary: missionDiary
      })
    });

    const data = await res.json();

    /* ===== NARRATION ===== */
    typeWriter(narration, data.narration || "‚Ä¶", 20);

    setTimeout(() => {
      typeWriter(choiceA, "A) " + data.choices.A, 12);
      typeWriter(choiceB, "B) " + data.choices.B, 12);
      typeWriter(choiceC, "C) " + data.choices.C, 12);
    }, 300);

    /* ===== TEST ===== */
    if (data.test && data.test.required === true) {

      const difficulty = data.test.difficulty;
      const d6 = rollD6();
      const outcome = resolveTest(d6, difficulty);

      document.getElementById("test-box").innerHTML =
        `üé≤ Dado: ${d6}<br>` +
        `‚ö†Ô∏è Difficolt√†: ${difficulty}<br>` +
        `üß™ Esito: ${esitoLabel(outcome)}`;

      const outcomeData = data.outcomes[outcome];

      if (outcomeData && outcomeData.effects) {
        if (outcomeData.effects.salute)
          playerState.salute += outcomeData.effects.salute;
        if (outcomeData.effects.stamina)
          playerState.stamina += outcomeData.effects.stamina;
        updateStatsUI();
      }

      lastTest = { d6, outcome };

    } else {
      document.getElementById("test-box").innerHTML =
        `üé≤ Dado: ‚Äî<br>‚ö†Ô∏è Difficolt√†: ‚Äî<br>üß™ Esito: ‚Äî`;
    }

    /* ===== UPDATE MISSION DIARY ===== */
    missionDiary.push({
      narration: data.narration,
      choice: choiceText,
      test: testToSend
    });

  } catch {
    narration.innerText = "Errore di comunicazione.";
  }
}

function choose(letter) {
  playTurn(letter);
}

/* ===== START ===== */
updateStatsUI();

(async () => {
  await loadGameManual();
  playTurn("inizio");
})();
</script>
