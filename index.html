<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Survival AI Game</title>

<style>
body {
  margin: 0;
  background: #0b0b0b;
  color: #caa56a;
  font-family: serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

#narration {
  max-width: 800px;
  text-align: center;
  font-size: 18px;
  margin-bottom: 30px;
}

#choices {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
}

.choice {
  padding: 12px 26px;
  border: 1px solid #caa56a;
  background: transparent;
  color: #caa56a;
  cursor: pointer;
  font-size: 16px;
}

.choice:hover {
  background: rgba(202,165,106,0.1);
}

#dice {
  font-size: 64px;
  margin: 20px;
  display: none;
}

#stats {
  display: flex;
  gap: 40px;
  margin-top: 20px;
  font-size: 14px;
}
</style>
</head>

<body>

<div id="narration">Caricamento...</div>

<div id="choices">
  <button class="choice" id="btnA">A</button>
  <button class="choice" id="btnB">B</button>
  <button class="choice" id="btnC">C</button>
</div>

<div id="dice"></div>

<div id="stats">
  <div>Salute: <span id="salute"></span></div>
  <div>Stress: <span id="stress"></span></div>
  <div>Risorse: <span id="risorse"></span></div>
</div>

<script>
const WORKER_URL = "https://still-hat-5795.salvatifranc.workers.dev";

let playerState = {
  salute: 4,
  stress: 2,
  risorse: 3
};

let lastAction = "inizio";
let currentTurn = null;

const narrationEl = document.getElementById("narration");
const diceEl = document.getElementById("dice");

const saluteEl = document.getElementById("salute");
const stressEl = document.getElementById("stress");
const risorseEl = document.getElementById("risorse");

function updateStats() {
  saluteEl.textContent = playerState.salute;
  stressEl.textContent = playerState.stress;
  risorseEl.textContent = playerState.risorse;
}

async function fetchTurn() {
  narrationEl.textContent = "Caricamento...";
  diceEl.style.display = "none";

  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      last_action: lastAction,
      player_state: playerState
    })
  });

  currentTurn = await res.json();

  narrationEl.textContent = currentTurn.narration;

  document.getElementById("btnA").textContent = "A – " + currentTurn.choices.A;
  document.getElementById("btnB").textContent = "B – " + currentTurn.choices.B;
  document.getElementById("btnC").textContent = "C – " + currentTurn.choices.C;

  if (currentTurn.test.required) {
    runTest();
  }
}

function runTest() {
  diceEl.style.display = "block";

  const roll = Math.ceil(Math.random() * 6);
  diceEl.textContent = roll;

  const success = roll >= currentTurn.test.difficulty;
  const effects = success ? currentTurn.effects.success : currentTurn.effects.fail;

  for (let k in effects) {
    playerState[k] += effects[k];
  }

  updateStats();
}

function choose(option) {
  lastAction = option;
  fetchTurn();
}

document.getElementById("btnA").onclick = () => choose("A");
document.getElementById("btnB").onclick = () => choose("B");
document.getElementById("btnC").onclick = () => choose("C");

updateStats();
fetchTurn();
</script>

</body>
</html>
