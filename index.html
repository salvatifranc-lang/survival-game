export default {
  async fetch(request, env) {

    if (request.method === "OPTIONS")
      return new Response(null, { headers: cors() });

    if (request.method !== "POST")
      return new Response("Not allowed", { status: 405, headers: cors() });

    let body = {};
    try { body = await request.json(); } catch {}

    const manual = body.game_manual || "";
    const prevNarration = body.previous_narration || "";
    const choiceText = body.choice_text || "";
    const testResult = body.test_result || null;

    /* ===== INCIPIT UNICO ===== */
    if (!prevNarration) {
      return json({
        narration:
`Benvenuto a Hope Town.
Anno 2095.

La superficie è morta.
Le macchine vegliano.

Tu sei un Rider.
La prima missione sta per cominciare.`,
        choices: {
          A: "Raggiungere il centro commerciale abbandonato",
          B: "Dirigerti verso la discarica delle macchine",
          C: "Scendere nella metropolitana sommersa"
        }
      });
    }

    /* ===== PROMPT CONTINUATIVO ===== */
    const prompt = `
SEI UN NARRATORE DI GIOCO SURVIVAL.

MANUALE DI GIOCO:
${manual}

STATO DEL MONDO (ULTIMA NARRAZIONE):
${prevNarration}

AZIONE COMPIUTA DAL GIOCATORE:
${choiceText}

${testResult ? `
ESITO DEL TEST:
- Dado: ${testResult.d6}
- Esito: ${testResult.outcome}
INTERPRETA L’ESITO NELLA NARRAZIONE.
` : `
NESSUN TEST È STATO EFFETTUATO.
PROSEGUI LA STORIA BASANDOTI SOLO SULL’AZIONE.
`}

REGOLE FERREE:
- DEVI descrivere cosa ACCADE DOPO l’azione.
- È VIETATO fermare la narrazione.
- È VIETATO ripetere la stessa situazione.
- Ogni risposta DEVE cambiare lo stato del mondo.
- Fornisci SEMPRE 3 nuove scelte narrative coerenti.

FORMATO JSON OBBLIGATORIO:
{
  "narration": "...",
  "choices": {
    "A": "...",
    "B": "...",
    "C": "..."
  },

  "test": {
    "required": true,
    "difficulty": "Rischioso",
    "difficulty_note": "...",
    "modifiers_note": "..."
  }
}

Se NON serve un test, ometti completamente "test".
`;

    return runAI(env, prompt);
  }
};

/* ===== AI ===== */
async function runAI(env, prompt) {
  try {
    const result = await env.AI.run(
      "@cf/meta/llama-3.1-8b-instruct",
      { prompt }
    );

    const data = JSON.parse(result.response || "");

    if (!data.narration || !data.choices?.A || !data.choices?.B || !data.choices?.C)
      return fallback();

    return json(data);

  } catch {
    return fallback();
  }
}

/* ===== UTILS ===== */
function json(obj) {
  return new Response(JSON.stringify(obj), {
    headers: { ...cors(), "Content-Type": "application/json" }
  });
}

function fallback() {
  return json({
    narration:
      "Il mondo non aspetta le tue decisioni. Qualcosa si muove, costringendoti a reagire.",
    choices: {
      A: "Agisci subito",
      B: "Ti sposti cercando riparo",
      C: "Forzi una scelta disperata"
    }
  });
}

function cors() {
  return {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type"
  };
}
